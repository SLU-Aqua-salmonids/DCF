---
title: "SERS Yearly report - DCF Electrofishing"
author: "Sölab"
date: "`r Sys.Date()`"
output:
  html_document: default
  word_document: default
  pdf_document:
    latex_engine: xelatex
header-includes: 
  - \usepackage[labelfont=bf]{caption}
  - \usepackage{longtable}
  - \usepackage{booktabs}
  - \usepackage{float}
  - \captionsetup{justification=raggedright,singlelinecheck=false}  
params:
  river: "Emån"
  year: 2024
---

```{r setup, include=FALSE}
##
## This template will produce a report electrofishing in the DCF program for one
## river and one year. The report will include tables with all sites fished and
## all sites not fished. A table with means for both salmon and trout are also
## produced, the means are weighted if needed.
## Change params river and year in the YML above and knit the file.
##
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(DCF)
library(ggplot2)
library(sf)
library(terra)
library(flextable)
flextable::set_flextable_defaults(border.width = .3)
river <- params$river
year <- params$year
sites <- DCF::dcf_known_efish_sites(river = river)
# Get results from SERS via dvfisk
efish_result <- DCF::dcf_get_efish_data(river, year = year) |>
  dplyr::arrange(hoh) |>
  dplyr::select(lokal, vattendrag, fiskedatum, xkoorlok, ykoorlok,
                lax0, lax, öring0, öring, antutfis) |>
  dplyr::left_join(sites, by=c("xkoorlok", "ykoorlok"))

 
# HACK: Special remove extra fishing done by other than DCF. When you find a new
## duplicated site add a filter to both res_salmon and res_trout here.
## If we could trust "syfte" we could use that instead.
efish_result <- efish_result |>
  dplyr::filter(!(vattendrag == "Vindelälven" & fiskedatum == 20230920 & lokal == "Linaforsen")) |>
  dplyr::filter(!(vattendrag == "Mattjokkbäcken" & fiskedatum == 20240910 & lokal == "Mynning 124")) |>
  dplyr::filter(!(vattendrag == "Åby älv" & fiskedatum == 20240814 & lokal == "Sandbacksforsen")) |>
  dplyr::filter(!(vattendrag == "Åby älv" & fiskedatum == 20240820 & lokal == "Brattforsen"))

# Create a table with known site information

site_table <- efish_result |>
  dplyr::mutate(Id = paste(xkoorlok, ykoorlok, sep = "-")) |>
  dplyr::mutate(Section = dplyr::if_else(is.na(section), "-", section)) |>
  dplyr::mutate(Used = dplyr::if_else(used, "Yes", "No")) |>
  dplyr::mutate(Orig = dplyr::if_else(since == 0, "Yes", "No")) |>
  group_by(Id) |>
  dplyr::mutate(N_visits = dplyr::n()) |>
  dplyr::ungroup() |>
  dplyr::mutate(N_visits = dplyr::if_else(is.na(fiskedatum), N_visits - 1, N_visits)) |>
  dplyr::select(Site = lokal, Id, Section, Area = area, Used, N_visits, Orig) |>
  dplyr::distinct()

not_fished <- efish_result |> dplyr::filter(is.na(fiskedatum))
used_sites <- efish_result |> dplyr::filter(used & !is.na(fiskedatum))

percent_YoY_salmon <- sum(used_sites$lax0 > 0) / nrow(used_sites) * 100
percent_older_salmon <- sum(used_sites$lax > 0) / nrow(used_sites) * 100


percent_YoY_trout <- sum(used_sites$öring0 > 0) / nrow(used_sites) * 100
percent_older_trout <- sum(used_sites$öring > 0) / nrow(used_sites) * 100
#
sections <- unique(sites$section)
# Prepare a map of the river and sites
map_sites <- DCF::dcf_known_efish_sites(river, as_sf = TRUE)
coords <- as.data.frame(sf::st_coordinates(sf::st_transform(map_sites, crs = 4326)))
coords$lokalnam <- map_sites$name
coords$fished <- ifelse(coords$lokalnam %in% not_fished$name, "No", "Yes")
coords$fished <- factor(coords$fished, levels = c("Yes", "No"))

bg <- terra::rast(system.file(paste0("maps/", river, ".png"), package = "DCF"))
site_map <- ggplot2::ggplot(data=coords, mapping = aes(x = X, y = Y)) +
  tidyterra::geom_spatraster_rgb(data = bg) +
  ggplot2::geom_point(aes(colour = fished)) +
  ggplot2::scale_color_manual(limits = c("Yes", "No"), values=c("black", "red")) +
  ggplot2::geom_text(aes(label=lokalnam), check_overlap = TRUE, size = 3) +
  ggplot2::labs(x = NULL, y = NULL) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 30))

```

## DCF electro fishing in  `r river` year `r year`

This is an autogenerated annual report for the DCF electrofishing program in
`r river` year `r year`. The report is generated with data from the SERS database
and knowledge about the DCF electrofishing program defined in the R-package `DCF`.
See Section Description in this report for more information about the report.



## Results

In `r river` `r nrow(sites)` sites should be fished each year, in `r year` sites
`r nrow(sites) - nrow(not_fished)` sites were fished. Fishing was done between
`r min(efish_result$fiskedatum, na.rm = TRUE)` and 
`r max(efish_result$fiskedatum, na.rm = TRUE)`. In Table 1 below
all sites are listed with information about the site defined in `DCF` (Site, Id,
Section, Area, Used and Orig), N_visits is the number of fishing occasions found
for this year. If the site has
more than one visit you should examine why and choose the right occasion, if visits
is zero no fishing was done (which might be normal but check why).
Zero+ salmon was found at `r round(percent_YoY_salmon, 0)` percent of the sites
and salmon older than 0+ at `r round(percent_older_salmon,0)` percent of the sites.
Zero+  trout was found at `r round(percent_YoY_trout, 0)` percent of the sites.

The "percent found" is calculated as the number of sites with catch > 0 divided by the
number of sites marked as used and fished this year.

```{r tab_site_overview, echo=FALSE, ft.align="left", results='asis'}
  cap <- paste("Sites defined in package DCF", river)
  ft <- site_table |>
    flextable::qflextable() |>
    flextable::color(i = ~ N_visits != 1,
                     j = "N_visits",
                     color = "red") |>
#    flextable::colformat_int(j = c(2,3), big.mark = "") |>
    flextable::set_caption(caption = cap) |>
    flextable::autofit()
  ft
```


```{r fig1, fig.cap="Map of sites", echo=FALSE, fig.pos="H"}
print(site_map)
```


```{r, tab_notfished, echo=FALSE, ft.align="left", results='asis'}
if (nrow(not_fished) > 0) {
   tab <-  not_fished |>
     dplyr::mutate(xkoorlok = as.integer(xkoorlok), ykoorlok = as.integer(ykoorlok)) |>
     dplyr::select(Site = lokalnam, xkoorlok, ykoorlok, Section = section)
   cap <- paste("DCF sites not fished in", river, "year", year)
   ft <- tab |>
     flextable::qflextable() |>
     flextable::colformat_int(j = c(2,3), big.mark = "") |>
     flextable::set_caption(caption = cap) |>
    flextable::autofit()
   ft
}
```

### Site estimates

```{r, tab_fished, echo=FALSE, ft.align="left", results='asis'}

cap <- paste("Estimated number of salmon and trout per 100 square meter at each site fished in", river, "year", year)
ft <- efish_result |>
  dplyr::filter(!is.na(fiskedatum)) |>
  dplyr::select(Site = lokal, Date = fiskedatum, lax0, lax,
                öring0, öring, antutfis) |>
  flextable::qflextable() |>
  flextable::colformat_int(j = 2, big.mark = "") |>
  flextable::set_caption(caption = cap) |>
  flextable::compose(
    i = 1, j = "lax0", part = "header",
    value = flextable::as_paragraph("Sal", flextable::as_sub("0+"))) |>
  flextable::compose(
    i = 1, j = "lax", part = "header",
    value = flextable::as_paragraph("Sal", flextable::as_sub(">0+"))) |>
  flextable::compose(
    i = 1, j = "öring0", part = "header",
    value = flextable::as_paragraph("Trout", flextable::as_sub("0+"))) |>
  flextable::compose(
    i = 1, j = "öring", part = "header",
    value = flextable::as_paragraph("Trout", flextable::as_sub(">0+"))) |>
  flextable::compose(
    i = 1, j = "antutfis", part = "header",
    value = flextable::as_paragraph("N", flextable::as_sub("passes"))) |>
  flextable::autofit()
ft
```




### River estimates

Some rivers are divided in 2 or more sections. When a river is divided the river
estimate is calculated as a weighted mean of the mean of each section using the
section area as weight. When there is only one section the estimate is a simple
mean over all sites.

`r river` has `r length(sections)` section(s) defined.

#### Weighted (if needed) mean of salmon and trout all sites (extended program)

```{r, tab_summary, echo=FALSE, ft.align="left", results='asis'}
# Calc straght means
tab <- used_sites |>
#  dplyr::filter(used, !is.na(oplus)) |>
  dplyr::select(Section = section, Area = area, lax0, lax, öring0, öring) |>
  dplyr::group_by(Section, Area) |>
  dplyr::summarise(
    Loplus = mean(lax0), 
    Lstorfisk  = mean(lax),
    Toplus = mean(öring0), 
    Tstorfisk  = mean(öring),
    N_sites = n(), 
    .groups = "drop")

if (length(sections) > 1) { ## Add weighted mean if more than one sections
  # Calc weighted mean
  weighted_tot <- tibble(Section = "Total (weighted)",
                         Area = NA,
                         Loplus = weighted.mean(tab$Loplus, tab$Area),
                         Lstorfisk = weighted.mean(tab$Lstorfisk, tab$Area),
                         Toplus = weighted.mean(tab$Toplus, tab$Area),
                         Tstorfisk = weighted.mean(tab$Tstorfisk, tab$Area),
                         N_sites = sum(tab$N_sites))
  
 tab <-  tab |>
    bind_rows(weighted_tot) 
}
tab <- tab |>
    dplyr::mutate(dplyr::across(dplyr::ends_with(c("oplus", "storfisk")),
                                ~round(.x, 1)))
  
# Format with flextable and print
cap <- paste("Mean number of 0+ salmon and trout per 100 square meter at each section in", river, "year", year)
ft <- tab |>
  flextable::qflextable() |>
  flextable::colformat_char(na_str = "-") |>
  flextable::compose(
    i = 1, j = "Loplus", part = "header",
    value = flextable::as_paragraph("Sal", flextable::as_sub("0+"))) |>
  flextable::compose(
    i = 1, j = "Lstorfisk", part = "header",
    value = flextable::as_paragraph("Sal", flextable::as_sub(">0+"))) |>
  flextable::compose(
    i = 1, j = "Toplus", part = "header",
    value = flextable::as_paragraph("Trout", flextable::as_sub("0+"))) |>
  flextable::compose(
    i = 1, j = "Tstorfisk", part = "header",
    value = flextable::as_paragraph("Trout", flextable::as_sub(">0+"))) |>
  flextable::compose(
    i = 1, j = "N_sites", part = "header",
    value = flextable::as_paragraph("N", flextable::as_sub("sites")))
if (length(sections) > 1) {
  ft <- ft |>
    flextable::bold(i = nrow(tab), j = 1, bold = TRUE)
}
ft <- ft |>
  flextable::set_caption(caption = cap) |>
  flextable::autofit()
ft
```


#### Unweighted mean of salmon and trout "original" sites

Table with results from "original", "not extended" sites. This is just unweighted
means for sites in the original electrofishing program.

```{r, tab_orig, echo=FALSE, ft.align="left", results='asis'}
## Create a table with unweighted means for original sites. Original sites are
## sites that have the value zero in the "since" column.
## The criteria for a site to be used is that it is marked as "used", 
## has been fished (!is.na(fiskedatum)) and has a value of zero in the "since" column.

salmon_orig <- efish_result |>
  dplyr::filter(used, !is.na(fiskedatum), since == 0) |>
  dplyr::select(Site = name, lax0, lax) |>
  dplyr::summarise(Oplus = mean(lax0), 
            Storfisk  = mean(lax),
            N_sites = n(),
            .groups = "drop") |>
  mutate(Species = "Salmon")

trout_orig <- efish_result |>
  dplyr::filter(used, !is.na(fiskedatum), since == 0) |>
  dplyr::select(Site = name, öring0, öring) |>
  dplyr::summarise(Oplus = mean(öring0), 
            Storfisk  = mean(öring),
            N_sites = n(),
            .groups = "drop") |>
  mutate(Species = "Trout")

tab <- rbind(salmon_orig, trout_orig) |>
  dplyr::select(Species, Oplus, Storfisk, N_sites)

cap <- paste("Unweighted Mean number of 0+ salmon and trout per 100 square meter at non extended sites in", river, "year", year)
ft<- tab |>
  flextable::qflextable() |>
  flextable::colformat_char(na_str = "-") |>
  flextable::colformat_double(digits = 1) |>
  flextable::compose(
    i = 1, j = 2, part = "header",
    value = flextable::as_paragraph("Sal", flextable::as_sub("0+"))) |>
  flextable::compose(
    i = 1, j = 3, part = "header",
    value = flextable::as_paragraph("Sal", flextable::as_sub(">0+"))) |>
  flextable::compose(
    i = 1, j = 4, part = "header",
    value = flextable::as_paragraph("N", flextable::as_sub("sites"))) |>
   flextable::set_caption(caption = cap) |>
  flextable::autofit()

ft

```


## Description

The report gives an overview of the fishing in the river, the sites fished and
and missing sites (if any). The report also includes estimates of the number parr
per site. The last table shows the mean number of parr per 100 square meter. If
the river is divided in sections (i.e. upstreams and downstream of some migration
obstacle) the mean is weighted by area of each section.

The data used in this report is extracted from the SERS database using infomation
on the DCF electrofishing program defined in the R-package `DCF`.

Due to limitations in SERS estimates are only available for two year classes, 0+
and older than 0+. For some rivers the WGBAST FLHM uses three year classes
(Åbyälven and north) and for those the estimates are from this report should not
be used as model input. The same is true if the estimates from a river need some
special adjustments, i.e. adjust for extra mortality in Åbyälven.
